{{ $raw := .Inner }}
{{ $steps := slice }}
{{ $currentStep := dict }}
{{ $currentSubsteps := slice }}
{{ range split $raw "\n" }}
  {{ $line := trim . " \t\r" }}
  {{ if hasPrefix $line "## " }}
    {{ if $currentStep.title }}
      {{ $currentStep = merge $currentStep (dict "substeps" $currentSubsteps) }}
      {{ $steps = $steps | append $currentStep }}
    {{ end }}
    {{ $title := trim (strings.TrimPrefix "## " $line) " " }}
    {{ $currentStep = dict "title" $title }}
    {{ $currentSubsteps = slice }}
  {{ else if hasPrefix $line "- " }}
    {{ $substep := trim (strings.TrimPrefix "- " $line) " " }}
    {{ $currentSubsteps = $currentSubsteps | append $substep }}
  {{ end }}
{{ end }}
{{ if $currentStep.title }}
  {{ $currentStep = merge $currentStep (dict "substeps" $currentSubsteps) }}
  {{ $steps = $steps | append $currentStep }}
{{ end }}
{{ $count := len $steps }}
{{ if gt $count 4 }}{{ $count = 4 }}{{ end }}
{{ $bgRed := "#fed7d7" }}
{{ $bgOrange := "#fef3c7" }}
{{ $bgYellow := "#fefcbf" }}
{{ $bgGreen := "#c6f6d5" }}
{{ $stRed := "#c53030" }}
{{ $stOrange := "#c05621" }}
{{ $stYellow := "#b7791f" }}
{{ $stGreen := "#276749" }}
{{ $colors := slice }}
{{ $strokes := slice }}
{{ if eq $count 1 }}
  {{ $colors = slice $bgGreen }}
  {{ $strokes = slice $stGreen }}
{{ else if eq $count 2 }}
  {{ $colors = slice $bgYellow $bgGreen }}
  {{ $strokes = slice $stYellow $stGreen }}
{{ else if eq $count 3 }}
  {{ $colors = slice $bgOrange $bgYellow $bgGreen }}
  {{ $strokes = slice $stOrange $stYellow $stGreen }}
{{ else }}
  {{ $colors = slice $bgRed $bgOrange $bgYellow $bgGreen }}
  {{ $strokes = slice $stRed $stOrange $stYellow $stGreen }}
{{ end }}
<div class="process-steps process-steps--{{ $count }}">
  <div class="process-steps__row">
    {{ range $i, $step := first $count $steps }}
      {{ $bg := index $colors $i }}
      {{ $border := index $strokes $i }}
      {{ $t := $step.title }}
      {{ $t = replaceRE "\\s*&\\s*" "\n&\n" $t }}
      {{ $t = replaceRE "[ \\t]+" " " $t }}
      <div class="process-steps__cell">
        <div class="process-steps__step" style="background: {{ $bg }}; border-color: {{ $border }};">
          <span class="process-steps__title">{{ $t }}</span>
        </div>
        {{ if $step.substeps }}
          <div class="process-steps__arrow process-steps__arrow--down">
            <svg viewBox="0 0 24 24" fill="none" stroke="{{ $border }}" stroke-width="2">
              <path d="M12 5v14M5 13l7 7 7-7"></path>
            </svg>
          </div>
          <ul class="process-steps__list" style="background: {{ $bg }}; border-color: {{ $border }};">
            {{ range $step.substeps }}
              <li>{{ . }}</li>
            {{ end }}
          </ul>
        {{ end }}
      </div>
      {{ if lt $i (sub $count 1) }}
        <div class="process-steps__arrow process-steps__arrow--right" style="color: {{ $border }};">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M13 5l7 7-7 7"></path>
          </svg>
        </div>
      {{ end }}
    {{ end }}
  </div>
</div>